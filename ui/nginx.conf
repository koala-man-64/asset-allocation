## Nginx config for the UI container (two-container deployment).
## - Serves the built SPA from /usr/share/nginx/html (copied by ui/Dockerfile).
## - Proxies /api/* and /config.js to the FastAPI container (single-origin in the browser).

# Map Upgrade header to a proper Connection value for WebSocket handshakes.
# - If Upgrade is present, send "Connection: upgrade".
# - If not, send "Connection: close".
map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

server {
  # UI container listens on port 80 (container port mapped by your orchestrator).
  listen 80;

  # Serve the React SPA (built assets) from the container filesystem.
  # - try_files attempts static assets first.
  # - falls back to /index.html to let the client router handle routes.
  location / {
    root /usr/share/nginx/html;
    index index.html;
    try_files $uri $uri/ /index.html;
  }

  # Runtime UI config served by the API (recommended).
  # - The SPA loads /config.js at runtime to set API base URL and auth settings.
  # - "no-store" prevents stale config from browser caches during deploys.
  location = /config.js {
    proxy_pass http://${API_UPSTREAM}/config.js;
    # Keep parity with /api proxying; some upstream ingress paths reject HTTP/1.0.
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $proxy_host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    add_header Cache-Control "no-store";
  }

  # Proxy API calls (and websockets) to FastAPI.
  # - Keep "/api" in the upstream path by omitting a trailing slash on proxy_pass.
  # - Example: /api/system/health -> http://backtest-api:8000/api/system/health
  location /api/ {
    proxy_pass http://${API_UPSTREAM};  # IMPORTANT: no trailing slash
    proxy_http_version 1.1;

    # Mitigate gateway timeouts when upstream health snapshots are slow.
    proxy_connect_timeout 15s;
    proxy_send_timeout 180s;
    proxy_read_timeout 180s;
    send_timeout 180s;

    # Preserve upstream request context for auth/logging.
    proxy_set_header Host $proxy_host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # WebSocket support for /api/ws/updates.
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }

  # Optional project-root-prefix support (e.g. /asset-allocation/api/*).
  # - The API mounts both /api/* and /<API_ROOT_PREFIX>/api/* when API_ROOT_PREFIX is set.
  # - /config.js may advertise the prefixed base URL (default behavior), so the UI proxy
  #   must forward these calls as well to keep a single-origin browser experience.
  location /asset-allocation/api/ {
    proxy_pass http://${API_UPSTREAM};  # IMPORTANT: no trailing slash
    proxy_http_version 1.1;

    # Match /api/ timeout behavior for prefixed API routing.
    proxy_connect_timeout 15s;
    proxy_send_timeout 180s;
    proxy_read_timeout 180s;
    send_timeout 180s;

    proxy_set_header Host $proxy_host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }
}

