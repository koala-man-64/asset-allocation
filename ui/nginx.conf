## Nginx config for the UI container (two-container deployment).
## - Serves the built SPA from /usr/share/nginx/html (copied by ui/Dockerfile).
## - Proxies /api/* and /config.js to the FastAPI container (single-origin in the browser).

# Map Upgrade header to a proper Connection value for WebSocket handshakes.
# - If Upgrade is present, send "Connection: upgrade".
# - If not, send "Connection: close".
map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

server {
  # UI container listens on port 80 (container port mapped by your orchestrator).
  listen 80;

  # Serve the React SPA (built assets) from the container filesystem.
  # - try_files attempts static assets first.
  # - falls back to /index.html to let the client router handle routes.
  location / {
    root /usr/share/nginx/html;
    index index.html;
    try_files $uri $uri/ /index.html;
  }

  # Runtime UI config served by the API (recommended).
  # - The SPA loads /config.js at runtime to set API base URL and auth settings.
  # - "no-store" prevents stale config from browser caches during deploys.
  location = /config.js {
    proxy_pass http://${API_UPSTREAM}/config.js;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    add_header Cache-Control "no-store";
  }

  # Proxy API calls (and websockets) to FastAPI.
  # - Keep "/api" in the upstream path by omitting a trailing slash on proxy_pass.
  # - Example: /api/system/health -> http://backtest-api:8000/api/system/health
  location /api/ {
    proxy_pass http://${API_UPSTREAM};  # IMPORTANT: no trailing slash
    proxy_http_version 1.1;

    # Preserve upstream request context for auth/logging.
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # WebSocket support for /api/ws/updates.
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }
}

