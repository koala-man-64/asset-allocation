name: Manual Job Trigger (Single Job)

on:
  workflow_dispatch:
    inputs:
      job:
        description: Select exactly one job to start
        required: true
        type: choice
        options:
          - bronze_market
          - bronze_finance
          - bronze_price_target
          - bronze_earnings
          - silver_market
          - silver_finance
          - silver_price_target
          - silver_earnings
          - gold_market
          - gold_finance
          - gold_price_target
          - gold_earnings

concurrency:
  group: manual-job-trigger-${{ github.event.inputs.job }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

env:
  RESOURCE_GROUP: AssetAllocationRG
  # Bronze
  BRONZE_MARKET_JOB: bronze-market-job
  BRONZE_FINANCE_JOB: bronze-finance-job
  BRONZE_PRICE_TARGET_JOB: bronze-price-target-job
  BRONZE_EARNINGS_JOB: bronze-earnings-job
  # Silver
  SILVER_MARKET_JOB: silver-market-job
  SILVER_FINANCE_JOB: silver-finance-job
  SILVER_PRICE_TARGET_JOB: silver-price-target-job
  SILVER_EARNINGS_JOB: silver-earnings-job
  # Gold
  GOLD_MARKET_JOB: gold-market-job
  GOLD_FINANCE_JOB: gold-finance-job
  GOLD_PRICE_TARGET_JOB: gold-price-target-job
  GOLD_EARNINGS_JOB: gold-earnings-job

jobs:
  trigger-job:
    runs-on: ubuntu-latest
    steps:
      - name: Azure login
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Resolve selected job
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          case "${{ github.event.inputs.job }}" in
            bronze_market) selected_job="${BRONZE_MARKET_JOB}" ;;
            bronze_finance) selected_job="${BRONZE_FINANCE_JOB}" ;;
            bronze_price_target) selected_job="${BRONZE_PRICE_TARGET_JOB}" ;;
            bronze_earnings) selected_job="${BRONZE_EARNINGS_JOB}" ;;
            silver_market) selected_job="${SILVER_MARKET_JOB}" ;;
            silver_finance) selected_job="${SILVER_FINANCE_JOB}" ;;
            silver_price_target) selected_job="${SILVER_PRICE_TARGET_JOB}" ;;
            silver_earnings) selected_job="${SILVER_EARNINGS_JOB}" ;;
            gold_market) selected_job="${GOLD_MARKET_JOB}" ;;
            gold_finance) selected_job="${GOLD_FINANCE_JOB}" ;;
            gold_price_target) selected_job="${GOLD_PRICE_TARGET_JOB}" ;;
            gold_earnings) selected_job="${GOLD_EARNINGS_JOB}" ;;
            *)
              echo "::error::Unsupported job input: ${{ github.event.inputs.job }}"
              exit 1
              ;;
          esac

          echo "job_name=${selected_job}" >> "$GITHUB_OUTPUT"
          echo "Selected job: ${selected_job}"

      - name: Trigger selected job
        run: |
          az containerapp job start \
            --name "${{ steps.resolve.outputs.job_name }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}"
