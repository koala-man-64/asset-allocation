<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rankings Explorer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --ink: #1b1b1b;
        --muted: #6b6b6b;
        --accent: #16697a;
        --accent-strong: #0e4d5a;
        --panel: #ffffff;
        --panel-border: rgba(27, 27, 27, 0.08);
        --bg: #f3efe4;
        --shadow: 0 20px 50px rgba(22, 105, 122, 0.12);
        --card-radius: 18px;
        --card-padding: 16px;
        --card-border: rgba(27, 27, 27, 0.08);
        --card-shadow: 0 1px 2px rgba(27, 27, 27, 0.05);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", sans-serif;
        color: var(--ink);
        background: radial-gradient(circle at top left, #fff7e9, var(--bg));
        min-height: 100vh;
      }

      .shell {
        width: 100%;
        max-width: none;
        margin: 0;
        padding: 48px 24px 32px;
        position: relative;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .status {
        position: absolute;
        top: 12px;
        right: 24px;
        font-size: 13px;
        color: var(--muted);
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--panel-border);
        border-radius: 18px;
        padding: 20px;
        box-shadow: var(--shadow);
        margin-top: 28px;
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 16px;
        flex-wrap: wrap;
      }

      .topbar a {
        color: var(--accent);
        text-decoration: none;
        font-weight: 600;
      }

      .topbar a:hover {
        text-decoration: underline;
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
        align-items: end;
        margin-top: 18px;
      }

      label {
        display: block;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin-bottom: 8px;
      }

      input,
      button {
        width: 100%;
        padding: 12px 14px;
        font-size: 15px;
        border-radius: 12px;
        border: 1px solid var(--panel-border);
        font-family: inherit;
      }

      button {
        background: var(--accent);
        color: #ffffff;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.2s ease, background 0.2s ease;
      }

      button:hover {
        background: var(--accent-strong);
        transform: translateY(-1px);
      }

      details.strategies {
        margin-top: 18px;
      }

      details.strategies > summary {
        cursor: pointer;
        list-style: none;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      details.strategies > summary::-webkit-details-marker {
        display: none;
      }

      details.strategies > summary::after {
        content: "▾";
        color: var(--muted);
        transition: transform 0.15s ease;
      }

      details.strategies:not([open]) > summary::after {
        transform: rotate(-90deg);
      }

      .strategies-body {
        margin-top: 12px;
        padding: 12px 14px;
        background: #fdf8f0;
        border-radius: 14px;
        border: 1px solid rgba(27, 27, 27, 0.06);
        font-size: 14px;
        color: var(--ink);
        max-height: 180px;
        overflow: auto;
      }

      .strategy-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 0;
      }

      .table-wrap {
        margin-top: 18px;
        flex: 1;
        overflow: auto;
        border-radius: var(--card-radius);
        border: 1px solid var(--card-border);
        padding: var(--card-padding);
        background: #ffffff;
        box-shadow: var(--card-shadow);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 820px;
      }

      thead th {
        position: sticky;
        top: 0;
        background: #f7f4ed;
        text-align: left;
        padding: 12px 14px;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        border-bottom: 1px solid var(--panel-border);
      }

      tbody td {
        padding: 10px 14px;
        border-bottom: 1px solid rgba(27, 27, 27, 0.04);
        font-size: 14px;
        color: var(--ink);
        white-space: nowrap;
      }

      tbody tr:hover td {
        background: rgba(22, 105, 122, 0.08);
      }

      .empty {
        padding: 24px;
        text-align: center;
        color: var(--muted);
      }

      @media (max-width: 720px) {
        .shell {
          padding: 32px 18px 48px;
        }
      }
    </style>
  </head>
  <body>
    <main class="shell">
      <div id="status" class="status"></div>

      <section class="panel">
        <div class="topbar">
          <h1 style="margin: 0; font-size: 22px">Rankings Explorer</h1>
          <a href="/">Data Preview</a>
        </div>

        <div class="controls">
          <div>
            <label for="date">Date</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label for="top-n">Top N</label>
            <input id="top-n" type="number" value="50" min="1" max="500" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="load">Load rankings</button>
          </div>
        </div>

        <details class="strategies" id="strategies-details" open>
          <summary id="strategies-summary">Strategies (0)</summary>
          <div class="strategies-body" id="strategies-body">
            <div class="empty">Loading strategies…</div>
          </div>
        </details>

        <div class="table-wrap">
          <div class="empty" id="empty">Select a date and load rankings.</div>
          <table id="table" hidden></table>
        </div>
      </section>
    </main>

    <script>
      const statusEl = document.getElementById("status");
      const dateEl = document.getElementById("date");
      const topNEl = document.getElementById("top-n");
      const loadBtn = document.getElementById("load");
      const strategiesSummary = document.getElementById("strategies-summary");
      const strategiesBody = document.getElementById("strategies-body");
      const emptyEl = document.getElementById("empty");
      const tableEl = document.getElementById("table");

      function setStatus(message) {
        statusEl.textContent = message;
      }

      async function fetchJson(url) {
        const response = await fetch(url);
        if (!response.ok) {
          const detail = await response.json().catch(() => ({}));
          const message = detail.detail || response.statusText;
          throw new Error(message);
        }
        return response.json();
      }

      function getSelectedStrategies() {
        const checked = Array.from(strategiesBody.querySelectorAll("input[type='checkbox']:checked"));
        return checked.map((el) => el.value);
      }

      function renderStrategies(strategies) {
        strategiesSummary.textContent = `Strategies (${strategies.length})`;
        if (!strategies.length) {
          strategiesBody.innerHTML = `<div class="empty">No strategies found for this month.</div>`;
          return;
        }
        strategiesBody.innerHTML = "";
        for (const strategy of strategies) {
          const wrapper = document.createElement("label");
          wrapper.className = "strategy-item";
          const input = document.createElement("input");
          input.type = "checkbox";
          input.value = strategy;
          input.checked = true;
          const span = document.createElement("span");
          span.textContent = strategy;
          wrapper.appendChild(input);
          wrapper.appendChild(span);
          strategiesBody.appendChild(wrapper);
        }
      }

      async function loadStrategies() {
        const dateValue = dateEl.value;
        if (!dateValue) {
          return;
        }
        try {
          setStatus("Loading strategies…");
          const data = await fetchJson(`/api/rankings/strategies?date=${encodeURIComponent(dateValue)}`);
          renderStrategies(data.strategies || []);
          setStatus("Ready.");
        } catch (error) {
          strategiesBody.innerHTML = `<div class="empty">${error.message}</div>`;
          strategiesSummary.textContent = "Strategies (0)";
          setStatus("Failed to load strategies.");
        }
      }

      function renderTable(snapshot) {
        const strategies = snapshot.strategies || [];
        const rows = snapshot.rows || [];

        if (!rows.length) {
          tableEl.hidden = true;
          tableEl.innerHTML = "";
          emptyEl.hidden = false;
          emptyEl.textContent = "No rankings found for this date.";
          return;
        }

        const theadCols = ["Symbol", "Composite Rank", "Composite %", "Hit (<=50)", ...strategies];
        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        for (const col of theadCols) {
          const th = document.createElement("th");
          th.textContent = col;
          headRow.appendChild(th);
        }
        thead.appendChild(headRow);

        const tbody = document.createElement("tbody");
        for (const row of rows) {
          const tr = document.createElement("tr");
          const cells = [
            row.symbol,
            row.composite_rank,
            row.composite_percentile.toFixed(4),
            row.strategies_hit,
          ];
          for (const value of cells) {
            const td = document.createElement("td");
            td.textContent = String(value);
            tr.appendChild(td);
          }

          for (const strategy of strategies) {
            const td = document.createElement("td");
            const rank = row.ranks ? row.ranks[strategy] : null;
            td.textContent = rank === null || rank === undefined ? "" : String(rank);
            tr.appendChild(td);
          }

          tbody.appendChild(tr);
        }

        tableEl.innerHTML = "";
        tableEl.appendChild(thead);
        tableEl.appendChild(tbody);
        tableEl.hidden = false;
        emptyEl.hidden = true;
      }

      async function loadSnapshot() {
        const dateValue = dateEl.value;
        if (!dateValue) {
          return;
        }
        const topN = Math.max(1, Math.min(500, Number(topNEl.value || 50)));
        const selected = getSelectedStrategies();
        const params = new URLSearchParams();
        params.set("date", dateValue);
        params.set("top_n", String(topN));
        for (const strategy of selected) {
          params.append("strategies", strategy);
        }

        try {
          setStatus("Loading rankings…");
          const snapshot = await fetchJson(`/api/rankings/snapshot?${params.toString()}`);
          renderTable(snapshot);
          setStatus(`Loaded ${snapshot.rows.length} rows for ${snapshot.date}.`);
        } catch (error) {
          tableEl.hidden = true;
          tableEl.innerHTML = "";
          emptyEl.hidden = false;
          emptyEl.textContent = error.message;
          setStatus("Failed to load rankings.");
        }
      }

      dateEl.addEventListener("change", async () => {
        await loadStrategies();
      });
      loadBtn.addEventListener("click", loadSnapshot);

      // Default to today's date for convenience.
      dateEl.valueAsDate = new Date();
      loadStrategies();
    </script>
  </body>
</html>

