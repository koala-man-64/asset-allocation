<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1"
    />
    <title>Asset Allocation Data Preview</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --ink: #1b1b1b;
        --muted: #6b6b6b;
        --accent: #16697a;
        --accent-strong: #0e4d5a;
        --panel: #ffffff;
        --panel-border: rgba(27, 27, 27, 0.08);
        --bg: #f3efe4;
        --shadow: 0 20px 50px rgba(22, 105, 122, 0.12);
        --card-radius: 18px;
        --card-padding: 16px;
        --card-border: rgba(27, 27, 27, 0.08);
        --card-shadow: 0 1px 2px rgba(27, 27, 27, 0.05);
        --panel-body-max-height: calc(100vh - 260px);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", sans-serif;
        color: var(--ink);
        background: radial-gradient(circle at top left, #fff7e9, var(--bg));
        min-height: 100vh;
      }

      .shell {
        width: 100%;
        max-width: none;
        margin: 0;
        padding: 48px 24px 32px;
        position: relative;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .status {
        position: absolute;
        top: 12px;
        right: 24px;
        font-size: 13px;
        color: var(--muted);
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--panel-border);
        border-radius: 18px;
        padding: 20px;
        box-shadow: var(--shadow);
        margin-top: 28px;
        flex: 1;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .panel-body {
        display: flex;
        flex-direction: row;
        gap: 16px;
        margin-top: 24px;
        align-items: stretch;
        width: 100%;
        flex: 1;
        min-height: 0;
        max-height: var(--panel-body-max-height);
        overflow: hidden;
      }

      .table-section,
      .chart-card {
        display: flex;
        flex-direction: column;
        min-height: 0;
        max-height: 100%;
        overflow: hidden;
        border-radius: var(--card-radius);
        border: 1px solid var(--card-border);
        padding: var(--card-padding);
        background: #ffffff;
        box-shadow: var(--card-shadow);
      }

      .table-section {
        flex: 0 1 42%;
        max-width: 42%;
        min-width: 240px;
      }

      .chart-card {
        flex: 1 1 58%;
        min-width: 0;
        background: #fffefa;
      }

      .chart-placeholder,
      .chart-area canvas {
        border-radius: 14px;
      }

      .chart-column-header {
        cursor: pointer;
        position: relative;
        user-select: none;
      }

      .chart-column-header.selected {
        background: rgba(22, 105, 122, 0.1);
      }

      .chart-column-header.date {
        cursor: default;
        color: rgba(27, 27, 27, 0.6);
      }

      .chart-area,
      .table-wrap {
        position: relative;
        flex: 1;
        min-height: 0;
        max-height: 100%;
        padding: 16px;
        background: #fdf8f0;
        border-radius: 16px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
      }

      .chart-area {
        overflow: hidden;
      }

      .chart-area canvas {
        width: 100%;
        height: 100%;
        display: block;
      }

      .chart-placeholder {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 16px;
        color: var(--muted);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.85);
        font-size: 14px;
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
        align-items: end;
      }

      label {
        display: block;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin-bottom: 8px;
      }

      select,
      button {
        width: 100%;
        padding: 12px 14px;
        font-size: 15px;
        border-radius: 12px;
        border: 1px solid var(--panel-border);
        font-family: inherit;
      }

      .column-list {
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      details.columns {
        margin-top: 20px;
      }

      details.columns > summary {
        cursor: pointer;
        list-style: none;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      details.columns > summary::-webkit-details-marker {
        display: none;
      }

      details.columns > summary::after {
        content: "▾";
        color: var(--muted);
        transition: transform 0.15s ease;
      }

      details.columns:not([open]) > summary::after {
        transform: rotate(-90deg);
      }

      .columns-body {
        margin-top: 12px;
        padding: 12px 14px;
        background: #fdf8f0;
        border-radius: 14px;
        border: 1px solid rgba(27, 27, 27, 0.06);
        font-size: 13px;
        color: var(--muted);
        max-height: 140px;
        overflow: auto;
        word-break: break-word;
        letter-spacing: normal;
        text-transform: none;
      }

      button {
        background: var(--accent);
        color: #ffffff;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.2s ease, background 0.2s ease;
      }

      button:hover {
        background: var(--accent-strong);
        transform: translateY(-1px);
      }

      .meta {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px 24px;
        font-size: 14px;
        color: var(--muted);
      }

      .meta span {
        color: var(--ink);
        font-weight: 500;
      }

      .table-wrap {
        width: 100%;
        flex: 1;
        overflow: auto;
        border-radius: 0;
        border: none;
        max-height: 100%;
        min-height: 0;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 0;
      }

      thead th {
        position: sticky;
        top: 0;
        background: #f7f4ed;
        text-align: left;
        padding: 12px 14px;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        border-bottom: 1px solid var(--panel-border);
      }

      tbody td {
        padding: 10px 14px;
        border-bottom: 1px solid rgba(27, 27, 27, 0.04);
        font-size: 14px;
        color: var(--ink);
        white-space: normal;
        word-break: break-word;
      }

      tbody tr:hover td {
        background: rgba(22, 105, 122, 0.08);
      }

      .empty {
        padding: 32px;
        text-align: center;
        color: var(--muted);
      }

      .fade-in {
        animation: fadeIn 0.4s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 720px) {
        .shell {
          padding: 32px 18px 48px;
        }

        .table-wrap {
          max-height: 420px;
        }
      }

      @media (max-width: 900px) {
        .panel-body {
          flex-direction: column;
        }
        .chart-card {
          flex: none;
          width: 100%;
        }
        .table-section {
          flex: none;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <main class="shell">
      <div id="status" class="status"></div>

      <section class="panel">
        <div class="controls">
          <div>
            <label for="container">Container</label>
            <select id="container"></select>
          </div>
          <div>
            <label for="blob">File</label>
            <select id="blob"></select>
          </div>
        </div>
        <details class="columns" id="available-columns" open>
          <summary class="column-list" id="available-columns-summary">Columns: –</summary>
          <div class="columns-body" id="available-columns-body">–</div>
        </details>

        <div class="meta" id="meta"></div>

        <div class="panel-body">
          <div class="table-section">
            <div class="table-wrap" id="table-wrap">
              <div class="empty" id="empty">Select a container to view data.</div>
              <table id="preview-table" class="fade-in" hidden></table>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-area">
              <canvas id="preview-chart"></canvas>
              <div class="chart-placeholder" id="chart-placeholder">
                Select a container and file to load a time series.
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const containerSelect = document.getElementById("container");
      const blobSelect = document.getElementById("blob");
      const statusEl = document.getElementById("status");
      const metaEl = document.getElementById("meta");
      const tableEl = document.getElementById("preview-table");
      const emptyEl = document.getElementById("empty");
      const chartPlaceholder = document.getElementById("chart-placeholder");
      const chartCanvas = document.getElementById("preview-chart");
      const columnsDetails = document.getElementById("available-columns");
      const columnsSummary = document.getElementById("available-columns-summary");
      const columnsBody = document.getElementById("available-columns-body");

      const chartColors = ["#16697a", "#f05d23", "#ffb703", "#0e4d5a", "#8ecae6", "#fb8500"];

      let previewChart = null;
      let previewState = { columns: [], rows: [] };
      let dateColumnIndex = 0;
      const selectedChartColumns = new Set();

      async function fetchJson(url) {
        const response = await fetch(url);
        if (!response.ok) {
          const detail = await response.json().catch(() => ({}));
          const message = detail.detail || response.statusText;
          throw new Error(message);
        }
        return response.json();
      }

      function setStatus(message) {
        statusEl.textContent = message;
      }

      function showChartPlaceholder(message) {
        chartPlaceholder.textContent = message;
        chartPlaceholder.style.display = "flex";
      }

      function hideChartPlaceholder() {
        chartPlaceholder.style.display = "none";
      }

      function destroyChart() {
        if (previewChart) {
          previewChart.destroy();
          previewChart = null;
        }
      }

      function resetTable(message) {
        tableEl.hidden = true;
        tableEl.innerHTML = "";
        emptyEl.textContent = message;
        emptyEl.hidden = false;
        metaEl.innerHTML = "";
        previewState = { columns: [], rows: [] };
        dateColumnIndex = 0;
        selectedChartColumns.clear();
        destroyChart();
        showChartPlaceholder("Select a container and file to load a time series.");
        updateAvailableColumns([]);
      }

      function renderMeta(data) {
        const parts = [
          `Format: <span>${data.format}</span>`,
          `Rows: <span>${data.preview_rows}</span>`,
          `Bytes read: <span>${data.bytes_read}</span>`,
          data.truncated ? "Preview: <span>truncated</span>" : "Preview: <span>complete</span>",
        ];
        if (data.last_modified) {
          parts.push(`Last modified: <span>${new Date(data.last_modified).toLocaleString()}</span>`);
        }
        metaEl.innerHTML = parts.join(" " );
      }

      function determineDateColumnIndex(columns) {
        const normalized = columns.map((col) => col.toLowerCase());
        const keywords = ["date", "timestamp", "time"];
        for (const keyword of keywords) {
          const idx = normalized.findIndex((col) => col.includes(keyword));
          if (idx !== -1) {
            return idx;
          }
        }
        return 0;
      }

      function syncSelectedColumns(columns) {
        if (!selectedChartColumns.size) {
          return;
        }
        selectedChartColumns.forEach((col) => {
          if (!columns.includes(col)) {
            selectedChartColumns.delete(col);
          }
        });
      }

      function updateAvailableColumns(columns = previewState.columns) {
        if (!columnsSummary || !columnsBody) {
          return;
        }
        const available = (columns || [])
          .map((col, index) => (index === dateColumnIndex ? null : col))
          .filter(Boolean);
        const label = available.length ? available.join(", ") : "None";
        columnsSummary.textContent = `Columns (${available.length})`;
        columnsBody.textContent = label;
        if (columnsDetails && available.length === 0) {
          columnsDetails.open = false;
        }
      }

      function renderTable() {
        const columns = previewState.columns;
        updateAvailableColumns(columns);
        if (!columns.length) {
          tableEl.hidden = true;
          emptyEl.hidden = false;
          emptyEl.textContent = "Select a container to view data.";
          return;
        }
        const rows = previewState.rows;
        if (!rows.length) {
          tableEl.hidden = true;
          tableEl.innerHTML = "";
          emptyEl.textContent = "No rows available.";
          emptyEl.hidden = false;
          return;
        }
        tableEl.innerHTML = "";
        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        columns.forEach((col, index) => {
          const th = document.createElement("th");
          th.textContent = col;
          th.dataset.colIndex = String(index);
          th.classList.add("chart-column-header");
          if (index === dateColumnIndex) {
            th.classList.add("date");
          } else {
            if (selectedChartColumns.has(col)) {
              th.classList.add("selected");
            }
            th.addEventListener("click", () => {
              if (selectedChartColumns.has(col)) {
                selectedChartColumns.delete(col);
                th.classList.remove("selected");
              } else {
                selectedChartColumns.add(col);
                th.classList.add("selected");
              }
              renderChart();
            });
          }
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        tableEl.appendChild(thead);

        const tbody = document.createElement("tbody");
        const fragment = document.createDocumentFragment();
        rows.forEach((row) => {
          const tr = document.createElement("tr");
          row.forEach((cell) => {
            const td = document.createElement("td");
            td.textContent = cell === null || cell === undefined ? "" : String(cell);
            tr.appendChild(td);
          });
          fragment.appendChild(tr);
        });
        tbody.appendChild(fragment);
        tableEl.appendChild(tbody);
        tableEl.hidden = false;
        emptyEl.hidden = true;
      }

      function buildChartLabels(rows) {
        return rows.map((row) => {
          const raw = row[dateColumnIndex];
          if (raw === undefined || raw === null) {
            return "";
          }
          const parsed = new Date(raw);
          if (!Number.isNaN(parsed.getTime())) {
            return parsed.toLocaleDateString();
          }
          return String(raw);
        });
      }

      function parseNumericValue(raw) {
        const value = Number(raw);
        return Number.isNaN(value) ? null : value;
      }

      function renderChart() {
        if (!previewState.columns.length) {
          destroyChart();
          showChartPlaceholder("Select a container and file to load a time series.");
          return;
        }
        const rows = previewState.rows;
        if (!rows.length) {
          destroyChart();
          showChartPlaceholder("No rows available to chart.");
          return;
        }
        const selectedColumns = previewState.columns.filter(
          (col, index) => index !== dateColumnIndex && selectedChartColumns.has(col)
        );
        if (!selectedColumns.length) {
          destroyChart();
          showChartPlaceholder("Click a column header to add it to the chart.");
          return;
        }
        const labels = buildChartLabels(rows);
        const datasets = selectedColumns.map((col, index) => {
          const columnIndex = previewState.columns.findIndex((value) => value === col);
          const color = chartColors[index % chartColors.length];
          return {
            label: col,
            data: previewState.rows.map((row) => parseNumericValue(row[columnIndex])),
            borderColor: color,
            backgroundColor: color,
            tension: 0.2,
            spanGaps: true,
            pointRadius: 0,
          };
        });
        const config = {
          type: "line",
          data: {
            labels,
            datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            resizeDelay: 200,
            animation: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            plugins: {
              legend: {
                position: "top",
              },
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: previewState.columns[dateColumnIndex] || "Date",
                },
              },
              y: {
                beginAtZero: false,
              },
            },
          },
        };
        if (previewChart) {
          previewChart.data = config.data;
          previewChart.options = config.options;
          previewChart.update();
        } else {
          previewChart = new Chart(chartCanvas, config);
        }
        hideChartPlaceholder();
      }

      function applyPreviewData(data) {
        previewState.columns = Array.isArray(data.columns) ? data.columns : [];
        previewState.rows = Array.isArray(data.rows) ? data.rows : [];
        dateColumnIndex = determineDateColumnIndex(previewState.columns);
        selectedChartColumns.clear();
        syncSelectedColumns(previewState.columns);
        renderTable();
        renderChart();
      }

      async function loadContainers() {
        try {
          setStatus("Loading containers...");
          const data = await fetchJson("/api/containers");
          containerSelect.innerHTML = "";
          if (!data.containers || data.containers.length === 0) {
            resetTable("No containers configured.");
            setStatus("No containers available.");
            return;
          }
          data.containers.forEach((container) => {
            const option = document.createElement("option");
            option.value = container;
            option.textContent = container;
            containerSelect.appendChild(option);
          });
          await loadFiles();
          setStatus("Ready.");
        } catch (error) {
          resetTable(error.message);
          setStatus("Failed to load containers.");
        }
      }

      async function loadFiles() {
        const container = containerSelect.value;
        if (!container) {
          resetTable("Select a container to continue.");
          return;
        }
        try {
          setStatus("Loading files...");
          const data = await fetchJson(`/api/files?container=${encodeURIComponent(container)}`);
          blobSelect.innerHTML = "";
          if (!data.files || data.files.length === 0) {
            resetTable("No supported files found in this container.");
            setStatus("No files available.");
            return;
          }
          data.files.forEach((file) => {
            const option = document.createElement("option");
            option.value = file;
            option.textContent = file;
            blobSelect.appendChild(option);
          });
          if (data.latest) {
            blobSelect.value = data.latest;
          }
          await loadPreview();
          setStatus("Ready.");
        } catch (error) {
          resetTable(error.message);
          setStatus("Failed to load files.");
        }
      }

      async function loadPreview() {
        const container = containerSelect.value;
        const blob = blobSelect.value;
        if (!container || !blob) {
          resetTable("Select a container and file.");
          return;
        }
        try {
          setStatus("Loading preview...");
          const data = await fetchJson(
            `/api/preview?container=${encodeURIComponent(container)}&blob=${encodeURIComponent(blob)}`
          );
          renderMeta(data);
          applyPreviewData(data);
          setStatus("Preview loaded.");
        } catch (error) {
          resetTable(error.message);
          setStatus("Failed to load preview.");
        }
      }

      containerSelect.addEventListener("change", loadFiles);
      blobSelect.addEventListener("change", loadPreview);
      loadContainers();
    </script>

  </body>
</html>
