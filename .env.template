# ==========================================
# Local Development & Logging
# ==========================================
DISABLE_DOTENV=false
LOG_FORMAT=JSON
LOG_LEVEL=INFO
TEST_MODE=false
ENABLE_ENV_DIAGNOSTICS=false

# Optional: debugging + tuning
DEBUG_SYMBOLS= # Fallback when Postgres debug_symbols is not configured (e.g. AAPL,MSFT)
SYMBOLS_REFRESH_INTERVAL_HOURS=24 # 0 disables periodic symbol refresh
FEATURE_ENGINEERING_MAX_WORKERS=
DOMAIN_METADATA_MAX_SCANNED_BLOBS=200000
ASSET_ALLOCATION_REQUIRE_AZURE_STORAGE=true

# ==========================================
# Azure Identity (GitHub deploy + optional local auth)
# ==========================================
# Required for GitHub Actions OIDC deploy:
AZURE_CLIENT_ID=
AZURE_TENANT_ID=
AZURE_SUBSCRIPTION_ID=eabd0bb1-8f36-4f27-ad86-8b33e02aaeb9
# Optional: Service Principal client secret (not required for GitHub OIDC)
AZURE_CLIENT_SECRET=

# ==========================================
# Azure Storage (required for pipelines)
# ==========================================
AZURE_STORAGE_ACCOUNT_NAME=assetallocstorage001
AZURE_STORAGE_CONNECTION_STRING=
# Optional auth alternatives (Delta Lake / blob access)
AZURE_STORAGE_ACCOUNT_KEY=
AZURE_STORAGE_ACCESS_KEY=
AZURE_STORAGE_SAS_TOKEN=

# ==========================================
# External Data APIs
# ==========================================
ALPHA_VANTAGE_API_KEY=
ALPHA_VANTAGE_RATE_LIMIT_PER_MIN=300
ALPHA_VANTAGE_TIMEOUT_SECONDS=15
ALPHA_VANTAGE_RATE_WAIT_TIMEOUT_SECONDS=600 # set <=0 to disable wait timeout
ALPHA_VANTAGE_THROTTLE_COOLDOWN_SECONDS=60 # minimum enforced value is 60
ALPHA_VANTAGE_MAX_WORKERS=32
ALPHA_VANTAGE_EARNINGS_FRESH_DAYS=7
ALPHA_VANTAGE_FINANCE_FRESH_DAYS=28
# Option A migration note: earnings Bronze still uses Alpha Vantage.

MASSIVE_API_KEY=
MASSIVE_BASE_URL=https://api.massive.com
MASSIVE_TIMEOUT_SECONDS=30
MASSIVE_PREFER_OFFICIAL_SDK=true
# Optional override for evolving Massive float endpoint versions (default: /stocks/vX/float).
MASSIVE_FLOAT_ENDPOINT=/stocks/vX/float
MASSIVE_MAX_WORKERS=10
MASSIVE_FINANCE_FRESH_DAYS=28

# Optional Massive flat-file access
MASSIVE_FLATFILES_ENDPOINT_URL=https://files.massive.com
MASSIVE_FLATFILES_BUCKET=flatfiles
MASSIVE_FLATFILES_ACCESS_KEY_ID=
MASSIVE_FLATFILES_SECRET_ACCESS_KEY=
MASSIVE_FLATFILES_SESSION_TOKEN=

# Optional Massive websocket defaults (comma-separated, e.g. T.AAPL,Q.AAPL,AM.AAPL)
MASSIVE_WS_SUBSCRIPTIONS=
NASDAQ_API_KEY=
MASSIVE_TICKERS_PAGE_LIMIT=1000

# ==========================================
# ETL -> API Gateway (provider access via Asset Allocation API)
# ==========================================
ASSET_ALLOCATION_API_BASE_URL=http://localhost:8000 # local default; Azure Jobs usually use http://asset-allocation-api (no port)
API_CONTAINER_APP_NAME=asset-allocation-api # Azure Container App resource name used by jobs for ARM wake/start.
ASSET_ALLOCATION_API_KEY= # optional if API_AUTH_MODE=none; otherwise set to the API key
ASSET_ALLOCATION_API_KEY_HEADER=X-API-Key
ASSET_ALLOCATION_API_TIMEOUT_SECONDS=600
ASSET_ALLOCATION_API_ALLOW_NO_AUTH=false
ASSET_ALLOCATION_API_WARMUP_ENABLED=true
ASSET_ALLOCATION_API_WARMUP_ATTEMPTS=3
ASSET_ALLOCATION_API_WARMUP_BASE_SECONDS=1.0
ASSET_ALLOCATION_API_WARMUP_MAX_SECONDS=8.0
ASSET_ALLOCATION_API_WARMUP_PROBE_TIMEOUT_SECONDS=5.0
JOB_STARTUP_API_WAKE_ENABLED=true
JOB_STARTUP_API_ARM_START_ENABLED=true
JOB_STARTUP_API_CONTAINER_APPS=asset-allocation-api # optional comma-separated override; defaults to API_CONTAINER_APP_NAME/base URL host
JOB_STARTUP_API_HEALTH_PATH=/healthz
JOB_STARTUP_API_PROBE_ATTEMPTS=6
JOB_STARTUP_API_PROBE_SLEEP_SECONDS=10
JOB_STARTUP_API_PROBE_TIMEOUT_SECONDS=5
JOB_STARTUP_API_START_ATTEMPTS=3
JOB_STARTUP_API_START_BASE_SECONDS=1.0

# ==========================================
# Storage Containers & Folders (canonical names)
# ==========================================
AZURE_CONTAINER_COMMON=common
AZURE_CONTAINER_BRONZE=bronze
AZURE_CONTAINER_SILVER=silver
AZURE_CONTAINER_GOLD=gold
AZURE_CONTAINER_PLATINUM=platinum
AZURE_FOLDER_MARKET=market-data
AZURE_FOLDER_FINANCE=finance-data
AZURE_FOLDER_EARNINGS=earnings-data
AZURE_FOLDER_TARGETS=price-target-data

# ==========================================
# Postgres
# ==========================================
POSTGRES_DSN=

# ==========================================
# API Service
# ==========================================
API_AUTH_MODE=none # none|api_key|oidc|api_key_or_oidc
API_KEY=
API_KEY_HEADER=X-API-Key
API_ROOT_PREFIX=asset-allocation # optional path prefix to mount the API under /{API_ROOT_PREFIX}/api/*
API_INGRESS_EXTERNAL=true # deploy: true for external ingress, false for internal only
API_PORT=8000
API_CSP="default-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https: wss:; base-uri 'none'; frame-ancestors 'none'"
API_CORS_ALLOW_ORIGINS= # comma-separated or JSON list; e.g. http://localhost:5173,http://127.0.0.1:5173
API_OIDC_ISSUER=
API_OIDC_AUDIENCE=
API_OIDC_JWKS_URL=
API_OIDC_REQUIRED_SCOPES=
API_OIDC_REQUIRED_ROLES=

UI_AUTH_MODE=none
UI_OIDC_CLIENT_ID=
UI_OIDC_AUTHORITY=
UI_OIDC_SCOPES=
UI_OIDC_REDIRECT_URI=
UI_API_BASE_URL=/api
UI_DIST_DIR=

# ==========================================
# System Health Monitoring (FastAPI: GET /api/system/health)
# ==========================================
SYSTEM_HEALTH_TTL_SECONDS=10
SYSTEM_HEALTH_MAX_AGE_SECONDS=129600
SYSTEM_HEALTH_FRESHNESS_OVERRIDES_JSON= # JSON object. Example: {"silver.market":{"maxAgeSeconds":43200},"gold.*":{"maxAgeSeconds":172800}}
SYSTEM_HEALTH_MARKERS_ENABLED=true
SYSTEM_HEALTH_MARKERS_CONTAINER=common
SYSTEM_HEALTH_MARKERS_PREFIX=system/health_markers
SYSTEM_HEALTH_MARKERS_DUAL_READ=false
SYSTEM_HEALTH_MARKERS_DUAL_READ_TOLERANCE_SECONDS=21600
SYSTEM_HEALTH_VERBOSE_IDS=
SYSTEM_HEALTH_LINK_TOKEN_SECRET= # secret used to sign health links (keep secret)

# Optional: Azure control-plane probes (ARM) for Container Apps + Jobs
SYSTEM_HEALTH_ARM_SUBSCRIPTION_ID=eabd0bb1-8f36-4f27-ad86-8b33e02aaeb9
SYSTEM_HEALTH_ARM_RESOURCE_GROUP=AssetAllocationRG
SYSTEM_HEALTH_ARM_CONTAINERAPPS=asset-allocation-api,asset-allocation-ui # comma-separated names
SYSTEM_HEALTH_ARM_JOBS=bronze-market-job,bronze-finance-job,bronze-price-target-job,bronze-earnings-job,silver-market-job,silver-finance-job,silver-price-target-job,silver-earnings-job,gold-market-job,gold-finance-job,gold-price-target-job,gold-earnings-job,reconcile-finance-coverage-job
SYSTEM_HEALTH_ARM_API_VERSION=2023-05-01
SYSTEM_HEALTH_ARM_TIMEOUT_SECONDS=5
SYSTEM_HEALTH_JOB_EXECUTIONS_PER_JOB=3

# Optional: Azure Resource Health (runtime availability)
SYSTEM_HEALTH_RESOURCE_HEALTH_ENABLED=false
SYSTEM_HEALTH_RESOURCE_HEALTH_API_VERSION=2022-10-01

# Optional: Azure Monitor Metrics (runtime telemetry)
SYSTEM_HEALTH_MONITOR_METRICS_ENABLED=false
SYSTEM_HEALTH_MONITOR_METRICS_API_VERSION=2018-01-01
SYSTEM_HEALTH_MONITOR_METRICS_TIMESPAN_MINUTES=15
SYSTEM_HEALTH_MONITOR_METRICS_INTERVAL=PT1M
SYSTEM_HEALTH_MONITOR_METRICS_AGGREGATION=Average
SYSTEM_HEALTH_MONITOR_METRICS_CONTAINERAPP_METRICS= # comma-separated metric names
SYSTEM_HEALTH_MONITOR_METRICS_JOB_METRICS= # comma-separated metric names
SYSTEM_HEALTH_MONITOR_METRICS_THRESHOLDS_JSON= # JSON object: {"MetricName":{"warn_above":80,"error_above":95}}

# Optional: Azure Log Analytics (KQL aggregates + job execution log tails)
SYSTEM_HEALTH_LOG_ANALYTICS_ENABLED=false
SYSTEM_HEALTH_LOG_ANALYTICS_WORKSPACE_ID=cb45286f-6177-4d38-85bd-828e768c07e5
SYSTEM_HEALTH_LOG_ANALYTICS_TIMEOUT_SECONDS=5
SYSTEM_HEALTH_LOG_ANALYTICS_TIMESPAN_MINUTES=15
SYSTEM_HEALTH_LOG_ANALYTICS_QUERIES_JSON= # JSON array: [{"resourceType":"Microsoft.App/containerApps","name":"errors_15m","query":"... {resourceName} ...","warnAbove":1,"errorAbove":10,"unit":"count"}]
# Example (single-line JSON; paste and adjust thresholds as needed):
# SYSTEM_HEALTH_LOG_ANALYTICS_QUERIES_JSON=[{"resourceType":"Microsoft.App/jobs","name":"job_errors_15m","query":"ContainerAppConsoleLogs_CL|where TimeGenerated>ago(15m)|where ContainerJobName_s=='{resourceName}'|extend j=parse_json(Log_s)|extend level=tostring(j.level)|where Stream_s=='stderr' or level in ('ERROR','CRITICAL') or Log_s has 'Traceback'|summarize count()","warnAbove":1,"errorAbove":10,"unit":"count"},{"resourceType":"Microsoft.App/containerApps","name":"app_errors_15m","query":"ContainerAppConsoleLogs_CL|where TimeGenerated>ago(15m)|where ContainerAppName_s=='{resourceName}'|extend j=parse_json(Log_s)|extend level=tostring(j.level)|where Stream_s=='stderr' or level in ('ERROR','CRITICAL') or Log_s has 'Traceback'|summarize count()","warnAbove":1,"errorAbove":10,"unit":"count"}]

# ==========================================
# Pipeline Controls
# ==========================================
SILVER_LATEST_ONLY=false # keep false to preserve historical corrections in delta refreshes
SILVER_MARKET_LATEST_ONLY=false
SILVER_FINANCE_LATEST_ONLY=false
SILVER_EARNINGS_LATEST_ONLY=false
SILVER_PRICE_TARGET_LATEST_ONLY=false
BACKFILL_START_DATE=2016-01-01 # global minimum date retained by domain reconciliation sweeps
SILVER_FINANCE_CATCHUP_MAX_PASSES=3 # bounded relist passes to absorb Bronze writes during a Silver run
FINANCE_RUN_MANIFESTS_ENABLED=true # emit/consume Bronze->Silver handoff manifests in AZURE_CONTAINER_COMMON
SILVER_FINANCE_USE_BRONZE_MANIFEST=true # when true, Silver prefers the latest unacked Bronze finance manifest
FINANCE_PIPELINE_SHARED_LOCK_NAME=finance-pipeline-shared # shared lock key used by Bronze+Silver finance jobs
BRONZE_FINANCE_SHARED_LOCK_WAIT_SECONDS=0 # 0 = skip if shared lock is held
SILVER_FINANCE_SHARED_LOCK_WAIT_SECONDS=3600 # seconds Silver waits for shared lock before failing
GOLD_MARKET_BY_DATE_ENABLED=false # when true, gold-market-job also writes a by-date view
GOLD_BY_DATE_DOMAIN=market # by-date source domain: market|finance|earnings|price-target
GOLD_MARKET_BY_DATE_PATH=market_by_date # target Delta table path in AZURE_CONTAINER_GOLD
GOLD_MARKET_BY_DATE_COLUMNS= # optional comma-separated projection from per-symbol Gold market data
MATERIALIZE_YEAR_MONTH= # optional YYYY-MM or YYYY-MM..YYYY-MM partition filter for partial by-date rebuild
TRIGGER_NEXT_JOB_NAME=
TRIGGER_NEXT_JOB_REQUIRED=true
TRIGGER_NEXT_JOB_RETRY_ATTEMPTS=3 # default 3
TRIGGER_NEXT_JOB_RETRY_BASE_SECONDS=1.0 # default 1.0

# ==========================================
# UI / CI Variables (GitHub Variables)
# ==========================================
VITE_PORT=5174
VITE_PROXY_CONFIG_JS=false # UI dev only: when true, proxy /config.js to the API (instead of serving ui/public/config.js)
VITE_API_PROXY_TARGET=http://127.0.0.1:8000 # UI dev only: Vite proxy target for /api (do not include /api)
SERVICE_ACCOUNT_NAME=asset-allocation-sa
KUBERNETES_NAMESPACE=k8s-apps
AKS_CLUSTER_NAME=
